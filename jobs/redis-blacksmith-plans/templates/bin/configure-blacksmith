#!/bin/bash
set -eu

PLANSRC=/var/vcap/jobs/redis-blacksmith-plans/plans
SVCROOT=/var/vcap/data/blacksmith/redis-forge/services
rm    -rf $SVCROOT
mkdir -p  $SVCROOT

# Copy the service definition stub for Blacksmith
cp $PLANSRC/service.yml $SVCROOT

<% p('plans').each do |id, plan| %>
##############################################
#
# Set up plan <%= id %>
#
PLANROOT="$SVCROOT/<%= id %>"
PLANTYPE="<%= plan["type"] || 'standalone' %>"

mkdir -p $PLANROOT
cat > $PLANROOT/plan.yml <<EOF
---
id: <%= id %>
name: <%= plan["name"] || id %>
limit: <%= plan["limit"] || 0 %>
type: <%= if plan["type"].include?("standalone")
            "standalone"
          elsif plan["type"].include?("cluster")
            "node"
          else
            plan["type"]
          end %>
description: |+
  <%= plan["description"] || 'no description provided' %>
EOF

for file in init credentials.yml manifest.yml; do
  cp $PLANSRC/$PLANTYPE/$file $PLANROOT/
done
chmod 0755 $PLANROOT/init

cat > $PLANROOT/params.yml <<EOF
---
# auto-generated by redis-blacksmith-plans
# for plan-id <%= id %> (<%= plan["name"] || id %>)
meta:
  size: <%= plan["vm_type"] || 'default' %>
  net:  <%= plan["network"] || 'redis-service' %>

  <% if plan["redis_maxmemory-policy"] %>
  redis_maxmemory-policy: <%= plan["redis_maxmemory-policy"] %>
  <% end %>

  <% if p('redis.tls.enabled') %> 
  redis:
    tls:
      enabled: true
      ca: (( file "/var/vcap/jobs/redis-blacksmith-plans/config/tls/redis.ca" ))
      ca_cert: (( file "/var/vcap/jobs/redis-blacksmith-plans/config/tls/redis.cert" ))
      ca_key: (( file "/var/vcap/jobs/redis-blacksmith-plans/config/tls/redis.key" ))
  <% end %>

  <% if p('redis.tls.dual-mode') -%> 
      dual-mode: true
  <% end %>

  <% if plan["redis_maxmemory"] %>
  redis_maxmemory: <%= plan["redis_maxmemory"] %>
  <% end %>

  <% if plan["redis_notify-keyspace-events"] %>
  redis_notify-keyspace-events: <%= plan["redis_notify-keyspace-events"] %>
  <% end %>

  <% if plan["redis_slowlog-log-slower-than"] %>
  redis_slowlog-log-slower-than: <%= plan["redis_slowlog-log-slower-than"] %>
  <% end %>

  <% if plan["redis_slowlog-max-len"] %>
  redis_slowlog-max-len: <%= plan["redis_slowlog-max-len"] %>
  <% end %>

  <% if plan.has_key?("redis_no-appendfsync-on-rewrite") %>
  redis_no-appendfsync-on-rewrite: <%= plan["redis_no-appendfsync-on-rewrite"] ? "yes" : "no" %>
  <% end %>

  <% if plan["redis_auto-aof-rewrite-percentage"] %>
  redis_auto-aof-rewrite-percentage: <%= plan["redis_auto-aof-rewrite-percentage"] %>
  <% end %>

  <% if plan["redis_auto-aof-rewrite-min-size"] %>
  redis_auto-aof-rewrite-min-size: <%= plan["redis_auto-aof-rewrite-min-size"] %>
  <% end %>

  <% if plan["client_timeout"] %>
  client_timeout: <%= plan["client_timeout"] %>
  <% end %>
  <% if plan["client_tcpkeepalive"] %>
  client_tcpkeepalive: <%= plan["client_tcpkeepalive"] %>
  <% end %>
  <% if plan["client_connections"] %>
  client_connections: <%= plan["client_connections"] %>
  <% end %>
  <% if plan.has_key?("lua_scripting_enabled") %>
  lua_scripting_enabled: <%= plan["lua_scripting_enabled"] %>
  <% end %>
  <% if plan["azs"] %>
  azs: <%= plan["azs"] %>
  <% end %>
  <% if plan["type"] =~ /standalone/ %>
  <% if plan["persist"] %>
  persistent: true
  <% if plan["disk_type"] %>
  disk_config: { persistent_disk_type: <%= plan["disk_type"] %> }
  <% else %>
  disk_config: { persistent_disk: <%= plan["disk_size"] || 1_024 %> }
  <% end %>
  <% else %>
  persistent: false
  <% end %>
  <% end %>

  <% if plan["type"] =~ /cluster/ && plan["masters"] > 0 %>
  masters:   <%= plan["masters"] %>
  replicas:  <%= plan["replicas"] || 1 %>
  instances: <%= plan["masters"] + plan["masters"] * (plan["replicas"] || 1) %>
  <% end %>

  <% if plan["exporter"] %>
releases:
- name:    prometheus
  version: 30.2.0
  url:     https://bosh.io/d/github.com/cloudfoundry-community/prometheus-boshrelease?v=30.2.0
  sha1:    0ba6f3eae9071fb554082398997d57a742c3fe3c

instance_groups:
- name: <%= plan["type"] =~ /standalone/ ? "standalone" : "node" %>
  jobs:
  - name: redis_exporter
    release: prometheus
    properties:
      redis_exporter:
        redis:
          password: (( grab meta.password ))
  <% end %>
EOF


<% end %>
